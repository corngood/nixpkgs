From 51ba2c2e473e87519e1217d7a43bf812c8ca9403 Mon Sep 17 00:00:00 2001
From: David McFarland <corngood@gmail.com>
Date: Sat, 30 Dec 2023 00:51:07 -0400
Subject: [PATCH 1/2] patch restored packages

---
 repo-projects/Directory.Build.targets | 24 ++++++++++++++++++++++++
 1 file changed, 24 insertions(+)

diff --git a/repo-projects/Directory.Build.targets b/repo-projects/Directory.Build.targets
index e1a5734ad5..3fa15da862 100644
--- a/repo-projects/Directory.Build.targets
+++ b/repo-projects/Directory.Build.targets
@@ -26,6 +26,29 @@
     <MSBuild Projects="@(_DependentProject)" Targets="Build" BuildInParallel="$(BuildInParallel)" StopOnFirstFailure="true" />
   </Target>
 
+  <Target Name="AddNixTargets"
+          BeforeTargets="Build"
+          Condition=" EXISTS('$(ProjectDirectory)Directory.Build.targets') OR EXISTS('$(ProjectDirectory)src/Directory.Build.targets')"
+          Inputs="$(MSBuildProjectFullPath)"
+          Outputs="$(RepoCompletedSemaphorePath)AddNixTargets.complete" >
+    <PropertyGroup>
+      <OldText><![CDATA[</Project>]]></OldText>
+      <NewText>
+        <![CDATA[  <Target Name="PatchNupkgs" AfterTargets="Restore" BeforeTargets="Build">
+    <Exec Command="patch-nupkgs %24(NUGET_PACKAGES) 2>&amp;1"/>
+  </Target>
+</Project>]]>
+      </NewText>
+
+      <DirectoryBuildTargetsFile Condition=" EXISTS('$(ProjectDirectory)Directory.Build.targets')">$(ProjectDirectory)Directory.Build.targets</DirectoryBuildTargetsFile>
+      <DirectoryBuildTargetsFile Condition=" '$(DirectoryBuildTargetsFile)' == '' AND EXISTS('$(ProjectDirectory)src/Directory.Build.targets')">$(ProjectDirectory)src/Directory.Build.targets</DirectoryBuildTargetsFile>
+    </PropertyGroup>
+    <ReplaceTextInFile InputFile="$(DirectoryBuildTargetsFile)"
+      OldText="$(OldText)"
+      NewText="$(NewText)"/>
+    <WriteLinesToFile File="$(RepoCompletedSemaphorePath)AddNixTargets.complete" Overwrite="true"/>
+  </Target>
+
   <Target Name="AddNoWarns"
           BeforeTargets="Build"
           Condition=" EXISTS('$(ProjectDirectory)Directory.Build.props') OR EXISTS('$(ProjectDirectory)src/Directory.Build.props') "
-- 
2.40.1

